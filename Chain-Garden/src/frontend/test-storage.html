<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Service æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #000;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: 2px solid #000;
            background: #fff;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
        button:hover {
            background: #00a651;
            color: white;
        }
        input {
            padding: 8px;
            border: 2px solid #000;
            font-family: monospace;
            width: 300px;
        }
        .output {
            background: #111;
            color: #0f0;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #000;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .wallet-info {
            background: #ff48b0;
            color: white;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #000;
        }
    </style>
</head>
<body>
    <h1>ğŸŒ± Chain Garden Storage æµ‹è¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>1. é’±åŒ…æ¨¡æ‹Ÿ</h2>
        <input type="text" id="walletInput" placeholder="è¾“å…¥é’±åŒ…åœ°å€ (å¦‚: 0xabc123...)">
        <button onclick="setWallet()">è®¾ç½®é’±åŒ…</button>
        <button onclick="clearWallet()">æ–­å¼€é’±åŒ…</button>
        <div class="wallet-info" id="walletInfo">æœªè¿æ¥é’±åŒ…ï¼ˆåŒ¿åæ¨¡å¼ï¼‰</div>
    </div>

    <div class="section">
        <h2>2. åˆ›å»º Specimen</h2>
        <input type="text" id="speciesName" placeholder="ç‰©ç§åç§°" value="Test Plant">
        <button onclick="createSpecimen()">åˆ›å»ºå¹¶ä¿å­˜</button>
    </div>

    <div class="section">
        <h2>3. æŸ¥çœ‹ Collection</h2>
        <button onclick="loadCollection()">åˆ·æ–° Collection</button>
        <button onclick="clearCollection()">æ¸…ç©ºå½“å‰é’±åŒ…çš„ Collection</button>
        <div class="output" id="collectionOutput">ç‚¹å‡»"åˆ·æ–° Collection"æŸ¥çœ‹æ•°æ®</div>
    </div>

    <div class="section">
        <h2>4. æŸ¥çœ‹åŸå§‹å­˜å‚¨</h2>
        <button onclick="viewRawStorage()">æŸ¥çœ‹ localStorage</button>
        <button onclick="clearAllStorage()">æ¸…ç©ºæ‰€æœ‰å­˜å‚¨</button>
        <div class="output" id="storageOutput">ç‚¹å‡»"æŸ¥çœ‹ localStorage"æŸ¥çœ‹åŸå§‹æ•°æ®</div>
    </div>

    <div class="section">
        <h2>5. æµ‹è¯•åœºæ™¯</h2>
        <button onclick="testScenario1()">åœºæ™¯1: åŒ¿å â†’ è¿æ¥é’±åŒ…</button>
        <button onclick="testScenario2()">åœºæ™¯2: åˆ‡æ¢é’±åŒ…</button>
        <button onclick="testScenario3()">åœºæ™¯3: æ•°æ®è¿ç§»</button>
    </div>

    <script>
        let currentWallet = null;

        // ç®€åŒ–ç‰ˆ StorageServiceï¼ˆç›´æ¥æ“ä½œ localStorageï¼‰
        const STORAGE_PREFIX = 'chainGarden_';
        const GLOBAL_COLLECTION_KEY = `${STORAGE_PREFIX}global_collection`;
        const WALLET_MAPPING_KEY = `${STORAGE_PREFIX}wallet_mapping`;
        const ANONYMOUS_KEY = `${STORAGE_PREFIX}anonymous`;

        function setWallet() {
            const input = document.getElementById('walletInput').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥é’±åŒ…åœ°å€');
                return;
            }
            currentWallet = input.toLowerCase();
            updateWalletInfo();
            loadCollection();
        }

        function clearWallet() {
            currentWallet = null;
            updateWalletInfo();
            loadCollection();
        }

        function updateWalletInfo() {
            const info = document.getElementById('walletInfo');
            if (currentWallet) {
                info.textContent = `å·²è¿æ¥: ${currentWallet}`;
                info.style.background = '#00a651';
            } else {
                info.textContent = 'æœªè¿æ¥é’±åŒ…ï¼ˆåŒ¿åæ¨¡å¼ï¼‰';
                info.style.background = '#ff48b0';
            }
        }

        function createSpecimen() {
            const name = document.getElementById('speciesName').value || 'Test Plant';
            
            const specimen = {
                id: 'spec_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                dna: {
                    speciesName: name,
                    mood: 'happy',
                    growthArchitecture: 'fractal_tree',
                    colorPalette: ['#1a1a1a', '#0078bf', '#ff48b0']
                },
                prompt: 'Test prompt',
                timestamp: Date.now(),
                imageData: 'data:image/png;base64,test'
            };

            // ä¿å­˜åˆ°å…¨å±€é›†åˆ
            const global = JSON.parse(localStorage.getItem(GLOBAL_COLLECTION_KEY) || '[]');
            global.unshift(specimen);
            localStorage.setItem(GLOBAL_COLLECTION_KEY, JSON.stringify(global));

            // å…³è”åˆ°é’±åŒ…æˆ–åŒ¿å
            if (currentWallet) {
                const mapping = JSON.parse(localStorage.getItem(WALLET_MAPPING_KEY) || '{}');
                if (!mapping[currentWallet]) mapping[currentWallet] = [];
                mapping[currentWallet].unshift(specimen.id);
                localStorage.setItem(WALLET_MAPPING_KEY, JSON.stringify(mapping));
            } else {
                const anon = JSON.parse(localStorage.getItem(ANONYMOUS_KEY) || '[]');
                anon.unshift(specimen.id);
                localStorage.setItem(ANONYMOUS_KEY, JSON.stringify(anon));
            }

            alert(`åˆ›å»ºæˆåŠŸ: ${name}`);
            loadCollection();
        }

        function loadCollection() {
            const global = JSON.parse(localStorage.getItem(GLOBAL_COLLECTION_KEY) || '[]');
            let specimenIds = [];

            if (currentWallet) {
                const mapping = JSON.parse(localStorage.getItem(WALLET_MAPPING_KEY) || '{}');
                specimenIds = mapping[currentWallet] || [];
            } else {
                specimenIds = JSON.parse(localStorage.getItem(ANONYMOUS_KEY) || '[]');
            }

            const collection = global.filter(s => specimenIds.includes(s.id));
            
            const output = document.getElementById('collectionOutput');
            if (collection.length === 0) {
                output.textContent = 'å½“å‰ collection ä¸ºç©º';
            } else {
                output.textContent = `æ‰¾åˆ° ${collection.length} ä¸ª specimens:\n\n` +
                    collection.map((s, i) => 
                        `${i + 1}. ${s.dna.speciesName} (ID: ${s.id})\n   åˆ›å»ºæ—¶é—´: ${new Date(s.timestamp).toLocaleString()}`
                    ).join('\n\n');
            }
        }

        function clearCollection() {
            if (!confirm('ç¡®å®šæ¸…ç©ºå½“å‰é’±åŒ…çš„ collectionï¼Ÿ')) return;

            const global = JSON.parse(localStorage.getItem(GLOBAL_COLLECTION_KEY) || '[]');
            let specimenIds = [];

            if (currentWallet) {
                const mapping = JSON.parse(localStorage.getItem(WALLET_MAPPING_KEY) || '{}');
                specimenIds = mapping[currentWallet] || [];
                delete mapping[currentWallet];
                localStorage.setItem(WALLET_MAPPING_KEY, JSON.stringify(mapping));
            } else {
                specimenIds = JSON.parse(localStorage.getItem(ANONYMOUS_KEY) || '[]');
                localStorage.removeItem(ANONYMOUS_KEY);
            }

            // ä»å…¨å±€é›†åˆä¸­åˆ é™¤
            const updated = global.filter(s => !specimenIds.includes(s.id));
            localStorage.setItem(GLOBAL_COLLECTION_KEY, JSON.stringify(updated));

            loadCollection();
        }

        function viewRawStorage() {
            const output = document.getElementById('storageOutput');
            const keys = Object.keys(localStorage).filter(k => k.startsWith(STORAGE_PREFIX));
            
            if (keys.length === 0) {
                output.textContent = 'æ²¡æœ‰ Chain Garden ç›¸å…³æ•°æ®';
                return;
            }

            output.textContent = keys.map(key => {
                const value = localStorage.getItem(key);
                const parsed = JSON.parse(value);
                return `${key}:\n${JSON.stringify(parsed, null, 2)}`;
            }).join('\n\n' + '='.repeat(50) + '\n\n');
        }

        function clearAllStorage() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰ Chain Garden æ•°æ®ï¼Ÿ')) return;
            
            Object.keys(localStorage)
                .filter(k => k.startsWith(STORAGE_PREFIX))
                .forEach(k => localStorage.removeItem(k));
            
            alert('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®');
            loadCollection();
            viewRawStorage();
        }

        // æµ‹è¯•åœºæ™¯
        function testScenario1() {
            alert('åœºæ™¯1: åŒ¿ååˆ›å»º â†’ è¿æ¥é’±åŒ…\n\næ­¥éª¤:\n1. ç¡®ä¿æœªè¿æ¥é’±åŒ…\n2. åˆ›å»ºå‡ ä¸ª specimens\n3. è¿æ¥é’±åŒ…\n4. æŸ¥çœ‹ collectionï¼ˆåº”è¯¥çœ‹åˆ°ä¹‹å‰åˆ›å»ºçš„ï¼‰');
        }

        function testScenario2() {
            alert('åœºæ™¯2: åˆ‡æ¢é’±åŒ…\n\næ­¥éª¤:\n1. è¿æ¥é’±åŒ… A (å¦‚: 0xaaa)\n2. åˆ›å»ºå‡ ä¸ª specimens\n3. åˆ‡æ¢åˆ°é’±åŒ… B (å¦‚: 0xbbb)\n4. æŸ¥çœ‹ collectionï¼ˆåº”è¯¥ä¸ºç©ºï¼‰\n5. åˆ›å»ºæ–° specimens\n6. åˆ‡æ¢å›é’±åŒ… A\n7. æŸ¥çœ‹ collectionï¼ˆåº”è¯¥çœ‹åˆ°ä¹‹å‰çš„ï¼‰');
        }

        function testScenario3() {
            alert('åœºæ™¯3: æ•°æ®è¿ç§»\n\næ­¥éª¤:\n1. æ‰‹åŠ¨åœ¨ localStorage åˆ›å»ºæ—§æ ¼å¼æ•°æ®\n2. åˆ·æ–°é¡µé¢\n3. åº”è¯¥è‡ªåŠ¨è¿ç§»åˆ°æ–°æ ¼å¼');
            
            // åˆ›å»ºæ—§æ ¼å¼æ•°æ®
            const oldData = [
                {
                    id: 'old_1',
                    dna: { speciesName: 'Old Plant 1', mood: 'calm' },
                    timestamp: Date.now()
                },
                {
                    id: 'old_2',
                    dna: { speciesName: 'Old Plant 2', mood: 'happy' },
                    timestamp: Date.now()
                }
            ];
            localStorage.setItem('chainGarden_collection', JSON.stringify(oldData));
            alert('å·²åˆ›å»ºæ—§æ ¼å¼æ•°æ®ï¼Œè¯·åˆ·æ–°é¡µé¢æµ‹è¯•è¿ç§»');
        }

        // åˆå§‹åŒ–
        updateWalletInfo();
    </script>
</body>
</html>
