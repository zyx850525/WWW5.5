// Prisma Schema for Cocreate Backend
// This schema defines the database structure for indexing blockchain data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Projects table - stores project information from blockchain
model Project {
  id            BigInt   @id @default(autoincrement())
  projectId     BigInt   @unique @map("project_id") // On-chain project ID
  ownerAddress  String   @map("owner_address") @db.VarChar(42)
  name          String   @db.VarChar(255)
  description   String?  @db.Text
  metadataUri   String?  @map("metadata_uri") @db.Text
  stakeAmount   String   @map("stake_amount") @db.VarChar(78) // Store as string for big numbers
  status        String   @db.VarChar(20) // 'active', 'finalized', 'cancelled'
  memberCount   Int      @default(0) @map("member_count")
  totalStaked   String   @default("0") @map("total_staked") @db.VarChar(78)
  totalSlashed  String   @default("0") @map("total_slashed") @db.VarChar(78)
  createdAt     DateTime @map("created_at")
  finalizedAt   DateTime? @map("finalized_at")
  createdAtBlock BigInt? @map("created_at_block")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  members       ProjectMember[]
  tasks         Task[]
  nfts          ContributionNFT[]
  events        BlockchainEvent[]

  @@index([ownerAddress], name: "idx_projects_owner")
  @@index([status], name: "idx_projects_status")
  @@index([createdAt], name: "idx_projects_created_at")
  @@map("projects")
}

// Project members table
model ProjectMember {
  id             BigInt   @id @default(autoincrement())
  projectId     BigInt   @map("project_id")
  memberAddress  String   @map("member_address") @db.VarChar(42)
  stakedAmount   String   @map("staked_amount") @db.VarChar(78)
  status         String   @db.VarChar(20) // 'staked', 'returned', 'slashed'
  joinedAt       DateTime @map("joined_at")
  tasksCompleted Int      @default(0) @map("tasks_completed")
  tasksRejected  Int      @default(0) @map("tasks_rejected")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  project        Project  @relation(fields: [projectId], references: [projectId], onDelete: Cascade)

  @@unique([projectId, memberAddress])
  @@index([projectId], name: "idx_members_project")
  @@index([memberAddress], name: "idx_members_address")
  @@map("project_members")
}

// Tasks table
model Task {
  id              BigInt   @id @default(autoincrement())
  taskId          BigInt   @unique @map("task_id") // On-chain task ID
  projectId      BigInt   @map("project_id")
  assigneeAddress String   @map("assignee_address") @db.VarChar(42)
  title           String   @db.VarChar(255)
  description     String?  @db.Text
  metadataUri     String?  @map("metadata_uri") @db.Text
  proofCid        String?  @map("proof_cid") @db.VarChar(100)
  status          String   @db.VarChar(20) // 'pending', 'submitted', 'under_review', 'approved', 'rejected'
  submittedAt     DateTime? @map("submitted_at")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewerAddress String?  @map("reviewer_address") @db.VarChar(42)
  rewardAmount    String   @default("0") @map("reward_amount") @db.VarChar(78)
  createdAt       DateTime @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  project         Project  @relation(fields: [projectId], references: [projectId], onDelete: Cascade)
  nft             ContributionNFT?

  @@index([projectId], name: "idx_tasks_project")
  @@index([assigneeAddress], name: "idx_tasks_assignee")
  @@index([status], name: "idx_tasks_status")
  @@map("tasks")
}

// Contribution NFTs table
model ContributionNFT {
  id                BigInt   @id @default(autoincrement())
  tokenId           BigInt   @unique @map("token_id")
  projectId        BigInt   @map("project_id")
  taskId           BigInt   @unique @map("task_id")
  contributorAddress String  @map("contributor_address") @db.VarChar(42)
  proofCid          String   @map("proof_cid") @db.VarChar(100)
  metadataUri       String?  @map("metadata_uri") @db.Text
  mintedAt          DateTime @map("minted_at")
  createdAt         DateTime @default(now()) @map("created_at")

  project           Project  @relation(fields: [projectId], references: [projectId], onDelete: Cascade)
  task              Task     @relation(fields: [taskId], references: [taskId], onDelete: Cascade)

  @@index([projectId], name: "idx_nfts_project")
  @@index([contributorAddress], name: "idx_nfts_contributor")
  @@index([taskId], name: "idx_nfts_task")
  @@map("contribution_nfts")
}

// Blockchain events table - stores all on-chain events for logging and audit
model BlockchainEvent {
  id              BigInt   @id @default(autoincrement())
  eventName       String   @map("event_name") @db.VarChar(100)
  contractAddress String   @map("contract_address") @db.VarChar(42)
  transactionHash String   @map("transaction_hash") @db.VarChar(66)
  blockNumber     BigInt   @map("block_number")
  logIndex        Int      @map("log_index")
  projectId       BigInt?  @map("project_id")
  taskId          BigInt?  @map("task_id")
  userAddress     String?  @map("user_address") @db.VarChar(42)
  eventData       Json     @map("event_data") // Store event data as JSON
  processed       Boolean  @default(false)
  createdAt       DateTime @default(now()) @map("created_at")

  project         Project? @relation(fields: [projectId], references: [projectId], onDelete: SetNull)

  @@unique([transactionHash, logIndex])
  @@index([projectId], name: "idx_events_project")
  @@index([taskId], name: "idx_events_task")
  @@index([userAddress], name: "idx_events_user")
  @@index([blockNumber], name: "idx_events_block")
  @@index([processed], name: "idx_events_processed")
  @@map("blockchain_events")
}

// IPFS files table - cache IPFS file metadata
model IpfsFile {
  id          BigInt   @id @default(autoincrement())
  cid         String   @unique @db.VarChar(100)
  fileName    String?  @map("file_name") @db.VarChar(255)
  fileSize    BigInt?  @map("file_size")
  mimeType    String?  @map("mime_type") @db.VarChar(100)
  uploadedBy  String?  @map("uploaded_by") @db.VarChar(42)
  uploadedAt  DateTime @default(now()) @map("uploaded_at")
  pinStatus   String   @default("pinned") @map("pin_status") @db.VarChar(20)

  @@index([cid], name: "idx_ipfs_cid")
  @@map("ipfs_files")
}

